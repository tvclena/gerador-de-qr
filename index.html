<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerador de QR Code â€¢ CLENA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>

<style>
:root{
  --bg:#0f0f10;
  --card:#1c1c1f;
  --accent:#22c55e;
  --danger:#ef4444;
  --text:#fff;
  --muted:#aaa;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,Arial;
  background:linear-gradient(135deg,#050505,#0f0f10);
  color:var(--text);
}
.container{
  max-width:1100px;
  margin:60px auto;
  padding:20px;
}
h1{
  font-size:28px;
  margin-bottom:20px;
}
.form{
  display:grid;
  grid-template-columns:1fr 2fr auto;
  gap:12px;
  margin-bottom:30px;
}
input,button{
  padding:14px;
  border-radius:10px;
  border:none;
  font-size:15px;
}
input{
  background:#222;
  color:#fff;
}
button{
  background:var(--accent);
  color:#000;
  font-weight:700;
  cursor:pointer;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:20px;
}
.card{
  background:var(--card);
  border-radius:16px;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.card img{
  width:100%;
  border-radius:12px;
  background:#fff;
}
.meta{
  font-size:13px;
  color:var(--muted);
}
.actions{
  display:flex;
  gap:8px;
}
.actions button{
  flex:1;
  font-size:13px;
  padding:10px;
}
.btn-open{background:#3b82f6;color:#fff}
.btn-copy{background:#eab308;color:#000}
.btn-del{background:var(--danger);color:#fff}
</style>
</head>

<body>
<div class="container">
  <h1>ðŸ“Ž Gerador de QR Code</h1>

  <div class="form">
    <input id="nome" placeholder="Nome do QR">
    <input id="destino" placeholder="URL de destino">
    <button onclick="gerar()">Gerar</button>
  </div>

  <div class="grid" id="lista"></div>
</div>

<script src="env.js"></script>
<script>
const sb = supabase.createClient(
  window.ENV.SUPABASE_URL,
  window.ENV.SUPABASE_ANON_KEY
)

const bucket = "qr-codes"

function slug(){
  return Math.random().toString(36).substring(2,10)
}

async function gerar(){
  const nome = nomeInput.value.trim()
  const destino = destinoInput.value.trim()
  if(!nome || !destino) return alert("Preencha tudo")

  const s = slug()
  const urlQR = `${window.ENV.SUPABASE_URL}/functions/v1/r/${s}`

  const canvas = document.createElement("canvas")
  await QRCode.toCanvas(canvas, urlQR, { width: 600 })

  const blob = await new Promise(r => canvas.toBlob(r))
  const fileName = `${nome.replace(/\s+/g,"_")}_${s}.png`

  await sb.storage.from(bucket).upload(fileName, blob, { upsert:true })

  const { data:img } = sb.storage.from(bucket).getPublicUrl(fileName)

  await sb.from("qr_codes").insert({
    nome,
    slug: s,
    destino,
    imagem_url: img.publicUrl
  })

  carregar()
}

async function carregar(){
  const { data } = await sb
    .from("qr_codes")
    .select("*")
    .order("criado_em",{ascending:false})

  lista.innerHTML = ""
  data.forEach(q => lista.innerHTML += card(q))
}

function card(q){
  return `
  <div class="card">
    <img src="${q.imagem_url}">
    <strong>${q.nome}</strong>
    <div class="meta">
      Slug: ${q.slug}<br>
      Acessos: ${q.acessos}<br>
      ${new Date(q.criado_em).toLocaleDateString("pt-BR")}
    </div>
    <div class="actions">
      <button class="btn-open" onclick="window.open('${q.destino}')">Abrir</button>
      <button class="btn-copy" onclick="copiar('${q.imagem_url}')">Copiar</button>
      <button class="btn-del" onclick="excluir('${q.id}')">Excluir</button>
    </div>
  </div>`
}

async function copiar(url){
  const res = await fetch(url)
  const blob = await res.blob()
  await navigator.clipboard.write([
    new ClipboardItem({ [blob.type]: blob })
  ])
  alert("Imagem copiada!")
}

async function excluir(id){
  if(!confirm("Excluir QR?")) return
  await sb.from("qr_codes").update({ativo:false}).eq("id",id)
  carregar()
}

const nomeInput = document.getElementById("nome")
const destinoInput = document.getElementById("destino")
const lista = document.getElementById("lista")

carregar()
</script>
</body>
</html>
